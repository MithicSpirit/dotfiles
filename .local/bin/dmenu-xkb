#!/usr/bin/env python

from collections import OrderedDict
from subprocess import Popen, PIPE
from sys import exit as exit_
from os import execvp

DEF_OPTIONS="grp:win_space_toggle,compose:rctrl,caps:escape_shifted_capslock,lv3:ralt_switch"

def main():

    options = OrderedDict()
    options["0. Math"] = ("us,gr,il", ",,phonetic", "")
    options["1. APL"] = ("us", "", "misc:apl")
    options["2. Greek"] = ("us,gr", ",", "")
    options["3. Hebrew"] = ("us,il", ",phonetic", "")

    Popen(["setxkbmap", "us", "-option", "", "-option", DEF_OPTIONS])
    sel = dmenu(options.keys())
    args = list(options[sel])
    args[2] += ("," if args[2] else "") + DEF_OPTIONS
    cmd = ["setxkbmap", *args]
    print(cmd)
    execvp(cmd[0], cmd)


def dmenu(opts):
    d = Popen(
        ["dmenu", "-bw", "3", "-c", "-R", "-l", "7", "-p", "Power"],
        stdout=PIPE,
        stdin=PIPE,
        stderr=PIPE,
    )
    out = d.communicate(str.join("\n", opts).encode())
    if out[1] or d.returncode:
        exit_(1)

    res = out[0].decode().strip()
    if res not in opts:
        exit_(2)
    return res


if __name__ == "__main__":
    main()
